<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<body>
<div th:replace="admin/layout :: layout(~{::content})">
  <div th:fragment="content">
    <div class="page-title-row">
      <div>
        <div class="page-title">âš™ï¸ Thiáº¿t láº­p cá»¥m Kubernetes báº±ng Ansible</div>
        <div class="page-subtitle">
          Thá»±c hiá»‡n cÃ i Ä‘áº·t Ansible, Kubernetes, CNI, Ingress, MetalLB trÃªn cÃ¡c server Ä‘Ã£ gÃ¡n.
        </div>
      </div>
      <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
        <select class="form-control" id="cluster-select" style="min-width: 200px; display: none;">
          <option value="">-- Chá»n cluster --</option>
        </select>
        <div id="cluster-status-display" class="cluster-info-display" style="padding: 8px 12px; background: #E3F2FD; border-radius: 6px; border: 1px solid #2196F3; font-size: 13px; color: #1565C0; display: flex; align-items: center; gap: 8px; white-space: nowrap;">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="width: 14px; height: 14px; border-width: 2px; color: #2196F3;"></span>
          <span>Äang táº£i thÃ´ng tin tráº¡ng thÃ¡i cá»¥m...</span>
        </div>
        <button class="btn" id="back-to-clusters-btn">â† Quay láº¡i danh sÃ¡ch</button>
      </div>
    </div>

    <!-- Step 1: Prepare Nodes -->
    <div class="table-card">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #E0E0E0;">
        <div class="page-title" style="font-size: 16px; margin-bottom: 0;">BÆ°á»›c 1 â€“ Chuáº©n bá»‹ Nodes</div>
        <button class="btn btn-primary" id="btn-step-1-prepare">âš™ï¸ Prepare Nodes</button>
      </div>
      <div class="page-subtitle" style="font-size: 13px; color: #666666; margin-top: 8px;">
        Chuáº©n bá»‹ táº¥t cáº£ nodes: cáº­p nháº­t hostname, system update, táº¯t swap (swapoff), load kernel modules (overlay, br_netfilter).
      </div>
    </div>

    <!-- Step 2: Setup Controller Node -->
    <div class="table-card" style="margin-top: 16px;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #E0E0E0;">
        <div class="page-title" style="font-size: 16px; margin-bottom: 0;">BÆ°á»›c 2 â€“ Táº¡o Controller Node</div>
        <button class="btn btn-primary" id="btn-step-2-controller">ğŸ–¥ï¸ Setup Controller</button>
      </div>
      <div class="page-subtitle" style="font-size: 13px; color: #666666; margin-top: 8px;">
        CÃ i Ä‘áº·t Python, Ansible, Git trÃªn controller node (mÃ¡y vá»›i role=ANSIBLE hoáº·c role=MASTER sáº½ Ä‘Æ°á»£c dÃ¹ng lÃ m controller Ä‘á»ƒ cháº¡y Ansible playbooks).
      </div>
    </div>

    <!-- Step 3: Clone Kubespray -->
    <div class="table-card" style="margin-top: 16px;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #E0E0E0;">
        <div class="page-title" style="font-size: 16px; margin-bottom: 0;">BÆ°á»›c 3 â€“ Clone Kubespray</div>
        <button class="btn btn-primary" id="btn-step-3-clone">ğŸ“¥ Clone Kubespray</button>
      </div>
      <div class="page-subtitle" style="font-size: 13px; color: #666666; margin-top: 8px;">
        Clone repository Kubespray tá»« GitHub vÃ o controller node (thÆ°á»ng clone vÃ o /opt/kubespray hoáº·c ~/kubespray).
      </div>
    </div>

    <!-- Step 4: Build Inventory -->
    <div class="table-card" style="margin-top: 16px;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #E0E0E0;">
        <div class="page-title" style="font-size: 16px; margin-bottom: 0;">BÆ°á»›c 4 â€“ Build Inventory</div>
        <button class="btn btn-primary" id="btn-step-4-inventory">ğŸ“‹ Build Inventory</button>
      </div>
      <div class="page-subtitle" style="font-size: 13px; color: #666666; margin-top: 8px;">
        Táº¡o inventory tá»« template cá»§a Kubespray, Ä‘iá»n thÃ´ng tin cÃ¡c nodes (IP, hostname, user) dá»±a trÃªn servers cÃ³ clusterStatus = 'AVAILABLE'.
      </div>
    </div>

    <!-- Step 5: Configure Roles -->
    <div class="table-card" style="margin-top: 16px;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #E0E0E0; flex-wrap: wrap; gap: 8px;">
        <div class="page-title" style="font-size: 16px; margin-bottom: 0;">BÆ°á»›c 5 â€“ Chá»‰nh roles trong inventory</div>
        <button class="btn btn-primary" id="btn-step-5-configure">âš™ï¸ Configure Roles</button>
      </div>
      <div class="page-subtitle" style="font-size: 13px; color: #666666; margin-top: 8px;">
        Chá»‰nh roles trong inventory cá»§a Kubespray (master/worker) dá»±a trÃªn servers Ä‘Ã£ gÃ¡n vÃ o cluster.
      </div>
      <!-- Cluster Info Display (similar to top) -->
      <div id="step5-cluster-info-display" class="cluster-info-display" style="margin-top: 12px; padding: 8px 12px; background: #E3F2FD; border-radius: 6px; border: 1px solid #2196F3; font-size: 13px; color: #1565C0; display: flex; align-items: center; gap: 8px;">
        <span>â„¹ï¸</span> <span>Äang táº£i thÃ´ng tin cluster...</span>
      </div>
    </div>

    <!-- Step 6: Deploy Cluster -->
    <div class="table-card" style="margin-top: 16px;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #E0E0E0;">
        <div class="page-title" style="font-size: 16px; margin-bottom: 0;">BÆ°á»›c 6 â€“ Deploy Cluster</div>
        <button class="btn btn-primary" id="btn-step-6-deploy">ğŸš€ Deploy Cluster</button>
      </div>
      <div class="page-subtitle" style="font-size: 13px; color: #666666; margin-top: 8px;">
        Cháº¡y <code>ansible-playbook cluster.yml</code> Ä‘á»ƒ triá»ƒn khai Kubernetes cluster (tá»± Ä‘á»™ng cÃ i container runtime, kubelet/kubeadm/kubectl, init master, join workers, CNI).
      </div>
    </div>

    <!-- Step 7: Get Kubeconfig -->
    <div class="table-card" style="margin-top: 16px;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #E0E0E0;">
        <div class="page-title" style="font-size: 16px; margin-bottom: 0;">BÆ°á»›c 7 â€“ Láº¥y Kubeconfig</div>
        <button class="btn btn-primary" id="btn-step-7-kubeconfig">ğŸ“„ Get Kubeconfig</button>
      </div>
      <div class="page-subtitle" style="font-size: 13px; color: #666666; margin-top: 8px;">
        Láº¥y kubeconfig tá»« master node (/etc/kubernetes/admin.conf) Ä‘á»ƒ quáº£n lÃ½ cluster tá»« mÃ¡y local hoáº·c controller.
      </div>
    </div>

    <!-- Step 8: Install Additional Addons (Optional) -->
    <div class="table-card" style="margin-top: 16px;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #E0E0E0; flex-wrap: wrap; gap: 8px;">
        <div class="page-title" style="font-size: 16px; margin-bottom: 0;">BÆ°á»›c 8 â€“ CÃ i Addons (TÃ¹y chá»n)</div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="btn" id="btn-step-8-calico">ğŸŒ Install Calico</button>
          <button class="btn" id="btn-step-8-ingress">ğŸšª Install Ingress</button>
          <button class="btn" id="btn-step-8-metallb">âš–ï¸ Install MetalLB</button>
          <button class="btn" id="btn-step-8-helm">ğŸ“¦ Install Helm</button>
        </div>
      </div>
      <div class="page-subtitle" style="font-size: 13px; color: #666666; margin-top: 8px;">
        <strong>LÆ°u Ã½:</strong> Náº¿u Ä‘Ã£ báº­t trong BÆ°á»›c 5 thÃ¬ cÃ¡c addon nÃ y Ä‘Ã£ Ä‘Æ°á»£c cÃ i tá»± Ä‘á»™ng. Chá»‰ cÃ i thá»§ cÃ´ng náº¿u chÆ°a báº­t hoáº·c muá»‘n cÃ i phiÃªn báº£n khÃ¡c.
      </div>
    </div>

    <!-- Step 9: Verify Cluster -->
    <div class="table-card" style="margin-top: 16px;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #E0E0E0;">
        <div class="page-title" style="font-size: 16px; margin-bottom: 0;">BÆ°á»›c 9 â€“ Verify Cluster</div>
        <button class="btn btn-primary" id="btn-step-9-verify">âœ… Verify</button>
      </div>
      <div class="page-subtitle" style="font-size: 13px; color: #666666; margin-top: 8px;">
        Kiá»ƒm tra tráº¡ng thÃ¡i nodes (Ready/NotReady), pods trong kube-system, network connectivity, vÃ  cÃ¡c thÃ nh pháº§n core cá»§a cluster.
      </div>
    </div>

    <!-- Ansible Section -->
    <div class="table-card" style="margin-top: 20px;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
        <div>
          <div class="page-title" style="font-size: 16px; margin-bottom: 4px;">âš™ï¸ Ansible</div>
          <div class="page-subtitle" style="font-size: 12px;">Quáº£n lÃ½ Ansible cho cá»¥m: kiá»ƒm tra tráº¡ng thÃ¡i, khá»Ÿi táº¡o, cáº¥u hÃ¬nh vÃ  playbook</div>
        </div>
        <button class="btn" id="cd-check-ansible">ğŸ” Kiá»ƒm tra tráº¡ng thÃ¡i</button>
      </div>
      <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; padding: 12px; background: #F8F9FA; border-radius: 6px;">
        <span class="chip" id="ansible-summary-install" style="background: #E0E0E0; color: #666666;">ChÆ°a kiá»ƒm tra</span>
        <span class="chip" id="ansible-summary-version" style="background: #E0E0E0; color: #666666;">PhiÃªn báº£n: -</span>
        <span class="chip" id="ansible-summary-master" style="background: #E0E0E0; color: #666666;">Controller: -</span>
        <div style="margin-left: auto;" id="ansible-summary-actions"></div>
      </div>
      <div style="padding: 12px; background: #F0F7FF; border-left: 3px solid #003366; border-radius: 6px; margin-bottom: 16px;">
        <div style="font-weight: 600; margin-bottom: 8px; color: #003366;">ğŸ“‹ HÆ°á»›ng dáº«n nhanh</div>
        <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #333333;">
          <li><strong>Controller</strong>: Há»‡ thá»‘ng tá»± Ä‘á»™ng chá»n controller (Æ°u tiÃªn role=ANSIBLE, náº¿u khÃ´ng cÃ³ thÃ¬ dÃ¹ng role=MASTER). Controller lÃ  mÃ¡y cháº¡y Ansible commands vÃ  quáº£n lÃ½ cá»¥m K8s.</li>
          <li><strong>Khá»Ÿi táº¡o</strong>: táº¡o cáº¥u trÃºc, ghi cáº¥u hÃ¬nh máº·c Ä‘á»‹nh, phÃ¢n phá»‘i SSH key tá»« controller Ä‘áº¿n cÃ¡c mÃ¡y trong cá»¥m, vÃ  ping nodes.</li>
          <li><strong>Cáº¥u hÃ¬nh</strong>: xem/sá»­a ansible.cfg, hosts (chá»‰ chá»©a MASTER vÃ  WORKER, khÃ´ng cÃ³ ANSIBLE), group_vars/all.yml trÃªn controller.</li>
          <li><strong>Playbook</strong>: quáº£n lÃ½ file, cháº¡y playbook trÃªn controller, theo dÃµi output real-time.</li>
        </ul>
        <div style="margin-top: 8px; padding: 8px; background: #E8F4F8; border-radius: 4px; font-size: 12px; color: #0066CC;">
          <strong>ğŸ’¡ Vá» SSH Key Distribution:</strong>
          <ul style="margin: 4px 0 0 0; padding-left: 20px; font-size: 11px;">
            <li>Náº¿u controller lÃ  <strong>ANSIBLE</strong>: phÃ¢n phá»‘i key Ä‘áº¿n táº¥t cáº£ MASTER vÃ  WORKER (clusterStatus=AVAILABLE)</li>
            <li>Náº¿u controller lÃ  <strong>MASTER</strong>: chá»‰ phÃ¢n phá»‘i key Ä‘áº¿n WORKER nodes</li>
          </ul>
        </div>
        <div style="margin-top: 8px; font-size: 12px; color: #666666;">LÆ°u Ã½: Sau khi thÃªm node má»›i, cáº§n cáº­p nháº­t cáº¥u hÃ¬nh Ansible (inventory) trÆ°á»›c khi cháº¡y playbook.</div>
      </div>
      <div id="ansible-status-display" style="margin-bottom: 16px;"></div>
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#initAnsibleModal">âš¡ Khá»Ÿi táº¡o</button>
        <button class="btn" data-bs-toggle="modal" data-bs-target="#ansibleConfigModal">âš™ï¸ Cáº¥u hÃ¬nh</button>
        <button class="btn" data-bs-toggle="modal" data-bs-target="#playbookManagerModal">ğŸ“„ Playbook & K8s</button>
      </div>
    </div>

    <!-- Modals -->
    <!-- Init Ansible Modal -->
    <div class="modal fade" id="initAnsibleModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">âš¡ Khá»Ÿi táº¡o Ansible</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Shared Output Console (top) -->
            <div class="card mb-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-semibold">Káº¿t quáº£</span>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="init-output-clear-btn">
                  ğŸ—‘ï¸ XÃ³a log
                </button>
              </div>
              <div class="card-body p-0">
                <div id="init-ansible-console" class="bg-dark text-light p-3" style="height: 320px; overflow: auto; font-family: monospace; font-size: 12px;">
                </div>
              </div>
            </div>

            <!-- Single consolidated guide -->
            <div class="card border-0 bg-light">
              <div class="card-body py-3">
                <div class="small mb-2 fw-semibold">ğŸ“‹ HÆ°á»›ng dáº«n nhanh (4 bÆ°á»›c):</div>
                <ol class="small mb-3 ps-3">
                  <li class="mb-1">
                    <strong>Táº¡o cáº¥u trÃºc</strong>: /etc/ansible, group_vars, host_vars, ~/.ansible.
                    Há»‡ thá»‘ng sáº½ xÃ¡c minh vÃ  bÃ¡o OK/FAIL.
                  </li>
                  <li class="mb-1">
                    <strong>Ghi cáº¥u hÃ¬nh</strong>: táº¡o/ghi Ä‘Ã¨ ansible.cfg vÃ  hosts dá»±a trÃªn cluster
                    (nhÃ³m master/workers vÃ  all:vars). Inventory chá»‰ chá»©a cÃ¡c mÃ¡y K8s nodes (MASTER vÃ  WORKER), khÃ´ng bao gá»“m mÃ¡y ANSIBLE controller.
                    Sau Ä‘Ã³ kiá»ƒm tra há»£p lá»‡ (ansible-inventory).
                  </li>
                  <li class="mb-1">
                    <strong>SSH key</strong>: Ä‘áº£m báº£o controller (ANSIBLE hoáº·c MASTER) cÃ³ id_rsa/id_rsa.pub vÃ  phÃ¢n phá»‘i key Ä‘áº¿n cÃ¡c mÃ¡y trong cá»¥m.
                    <ul class="mt-1 mb-0 ps-3" style="font-size: 11px;">
                      <li>Náº¿u controller lÃ  <strong>ANSIBLE</strong>: phÃ¢n phá»‘i key Ä‘áº¿n táº¥t cáº£ MASTER vÃ  WORKER (clusterStatus=AVAILABLE)</li>
                      <li>Náº¿u controller lÃ  <strong>MASTER</strong>: chá»‰ phÃ¢n phá»‘i key Ä‘áº¿n WORKER nodes</li>
                    </ul>
                  </li>
                  <li class="mb-1">
                    <strong>Ping nodes</strong>: kiá»ƒm tra káº¿t ná»‘i táº¥t cáº£ hosts báº±ng inventory vá»«a táº¡o.
                  </li>
                </ol>
                <div class="small text-muted">
                  Máº¹o: Nháº¥n "Khá»Ÿi táº¡o" Ä‘á»ƒ cháº¡y láº§n lÆ°á»£t 4 bÆ°á»›c. Náº¿u tÃ i khoáº£n cÃ³ <code>sudo NOPASSWD</code> sáº½ khÃ´ng cáº§n máº­t kháº©u; náº¿u khÃ´ng, há»‡ thá»‘ng sáº½ yÃªu cáº§u nháº­p.
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="btn-toolbar w-100 justify-content-between" role="toolbar" aria-label="Init toolbar">
              <div class="btn-group" role="group" aria-label="Primary action">
                <button type="button" class="btn btn-success" id="init-all-btn" title="Thá»±c hiá»‡n toÃ n bá»™ 4 bÆ°á»›c">
                  âš¡ Khá»Ÿi táº¡o
                </button>
              </div>
              <div class="btn-group" role="group" aria-label="Secondary actions">
                <button type="button" class="btn btn-outline-success btn-sm" id="init-structure-btn" title="Táº¡o cáº¥u trÃºc thÆ° má»¥c Ansible">
                  ğŸ“ Táº¡o cáº¥u trÃºc
                </button>
                <button type="button" class="btn btn-outline-primary btn-sm" id="init-config-btn" title="Ghi ansible.cfg vÃ  hosts máº·c Ä‘á»‹nh">
                  ğŸ“ Config máº·c Ä‘á»‹nh
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="init-sshkey-btn" title="Táº¡o vÃ  phÃ¢n phá»‘i SSH key tá»« controller Ä‘áº¿n cÃ¡c mÃ¡y trong cá»¥m">
                  ğŸ”‘ SSH key
                </button>
                <button type="button" class="btn btn-outline-info btn-sm" id="init-ping-btn" title="Kiá»ƒm tra káº¿t ná»‘i cÃ¡c node">
                  ğŸ“¡ Ping nodes
                </button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal" title="ÄÃ³ng cá»­a sá»•">ÄÃ³ng</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- End Init Ansible Modal -->

    <!-- Ansible Config Modal -->
    <div class="modal fade" id="ansibleConfigModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">âš™ï¸ Cáº¥u hÃ¬nh Ansible</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-header bg-light border-bottom">
            <div class="d-flex justify-content-between align-items-center w-100">
              <div class="text-muted small">
                â„¹ï¸ Cáº¥u hÃ¬nh sáº½ Ä‘Æ°á»£c Ã¡p dá»¥ng cho controller (Æ°u tiÃªn role=ANSIBLE, náº¿u khÃ´ng cÃ³ thÃ¬ dÃ¹ng role=MASTER)
              </div>
            </div>
          </div>
          <div class="modal-body">
            <!-- Status Information Panel -->
            <div class="mb-3">
              <div class="alert alert-info d-flex align-items-center" id="config-status-panel" role="alert">
                â„¹ï¸
                <div class="flex-grow-1 ms-2">
                  <strong>Tráº¡ng thÃ¡i cáº¥u hÃ¬nh:</strong>
                  <span id="config-status-text">ChÆ°a kiá»ƒm tra</span>
                </div>
                <div class="ms-2">
                  <small class="text-muted" id="config-last-check">-</small>
                </div>
              </div>
            </div>

            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-3" id="configTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-ansible-cfg" data-bs-toggle="tab"
                  data-bs-target="#tab-pane-ansible-cfg" type="button" role="tab" aria-controls="tab-pane-ansible-cfg"
                  aria-selected="true">
                  ğŸ“ ansible.cfg
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-inventory" data-bs-toggle="tab" data-bs-target="#tab-pane-inventory"
                  type="button" role="tab" aria-controls="tab-pane-inventory" aria-selected="false">
                  ğŸ–¥ Inventory (hosts)
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-variables" data-bs-toggle="tab" data-bs-target="#tab-pane-variables"
                  type="button" role="tab" aria-controls="tab-pane-variables" aria-selected="false">
                  âš™ï¸ Variables (group_vars/all.yml)
                </button>
              </li>
            </ul>

            <!-- Tab Contents -->
            <div class="tab-content" id="configTabContent">
              <!-- ansible.cfg Tab -->
              <div class="tab-pane fade show active" id="tab-pane-ansible-cfg" role="tabpanel"
                aria-labelledby="tab-ansible-cfg">
                <div class="mb-3">
                  <h6 class="mb-3">ansible.cfg</h6>
                  <textarea id="ansible-cfg-editor" class="form-control" rows="15"
                    placeholder="[defaults]\ninventory=/etc/ansible/hosts\n..."></textarea>
                </div>
              </div>

              <!-- Inventory Tab -->
              <div class="tab-pane fade" id="tab-pane-inventory" role="tabpanel" aria-labelledby="tab-inventory">
                <div class="mb-3">
                  <h6 class="mb-3">Inventory (hosts)</h6>
                  <textarea id="ansible-inventory-editor" class="form-control" rows="15"
                    placeholder="[master]\n127.0.0.1 ansible_connection=local\n..."></textarea>
                </div>
              </div>

              <!-- Variables Tab -->
              <div class="tab-pane fade" id="tab-pane-variables" role="tabpanel" aria-labelledby="tab-variables">
                <div class="mb-3">
                  <h6 class="mb-3">Variables (group_vars/all.yml)</h6>
                  <textarea id="ansible-vars-editor" class="form-control" rows="15"
                    placeholder="key: value\n..."></textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÄÃ³ng</button>
            <button type="button" class="btn btn-info" id="reload-config-btn">
              ğŸ”„ Táº£i láº¡i
            </button>
            <button type="button" class="btn btn-success" id="verify-ansible-btn">
              âœ… XÃ¡c minh
            </button>
            <button type="button" class="btn btn-warning" id="rollback-config-btn">
              â®ï¸ Rollback
            </button>
            <button type="button" class="btn btn-primary" id="save-ansible-config-btn">
              ğŸ’¾ LÆ°u cáº¥u hÃ¬nh
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- End Ansible Config Modal -->

    <!-- Playbook Manager Modal -->
    <div class="modal fade" id="playbookManagerModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ğŸ“„ Quáº£n lÃ½ playbook & cÃ i Ä‘áº·t K8s</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="d-flex justify-content-between mb-3">
              <div>
                <button type="button" class="btn btn-sm btn-outline-primary" id="create-playbook-btn">
                  â• Táº¡o playbook</button>
                <button type="button" class="btn btn-sm btn-outline-success" id="generate-from-template-btn">
                  âœ¨ Táº¡o tá»« template</button>
                <label class="btn btn-sm btn-outline-secondary mb-0">
                  ğŸ“¤ Táº£i lÃªn <input type="file" id="upload-playbook-input"
                    accept=".yml,.yaml" hidden>
                </label>
                <button type="button" class="btn btn-sm btn-outline-info" id="refresh-playbooks-btn">
                  ğŸ”„ LÃ m má»›i</button>
              </div>
              <div class="input-group input-group-sm" style="max-width: 320px;">
                <span class="input-group-text">ğŸ”</span>
                <input type="text" id="search-playbook-input" class="form-control" placeholder="TÃ¬m playbook...">
              </div>
            </div>
            <hr>
            <!-- Filename and Template in same row -->
            <div class="row g-3 mb-3">
              <div class="col-6">
                <label class="form-label">TÃªn file playbook</label>
                <div class="input-group">
                  <input type="text" id="playbook-filename" class="form-control" placeholder="example" required>
                  <span class="input-group-text">.yml</span>
                </div>
                <small class="text-muted">Extension .yml sáº½ Ä‘Æ°á»£c thÃªm tá»± Ä‘á»™ng</small>
              </div>
              <div class="col-6">
                <label class="form-label">Template K8s (tÃ¹y chá»n)</label>
                <select id="playbook-template-select" class="form-select form-select-sm">
                  <option value="">-- Chá»n template K8s --</option>
                  <optgroup label="I. Chuáº©n bá»‹ mÃ´i trÆ°á»ng">
                    <option value="update-hosts-hostname">01 ğŸ“ Cáº­p nháº­t hosts & hostname</option>
                    <option value="kernel-sysctl">02 âš™ï¸ Cáº¥u hÃ¬nh kernel & sysctl</option>
                    <option value="install-containerd">03 ğŸ³ CÃ i Ä‘áº·t containerd</option>
                    <option value="install-kubernetes">04 â˜¸ï¸ CÃ i Ä‘áº·t kubeadm/kubelet/kubectl</option>
                  </optgroup>
                  <optgroup label="II. Triá»ƒn khai cluster">
                    <option value="init-master">05 ğŸš€ Khá»Ÿi táº¡o master node</option>
                    <option value="install-cni">06 ğŸŒ CÃ i Ä‘áº·t Calico CNI</option>
                    <option value="install-flannel">06 ğŸŒ CÃ i Ä‘áº·t Flannel CNI</option>
                    <option value="join-workers">07 ğŸ”— ThÃªm worker nodes</option>
                  </optgroup>
                  <optgroup label="III. Kiá»ƒm tra & TÃ¹y chá»n má»Ÿ rá»™ng">
                    <option value="verify-cluster">08 ğŸ§© XÃ¡c minh tráº¡ng thÃ¡i cá»¥m</option>
                    <option value="install-helm">09 ğŸ“¦ CÃ i Ä‘áº·t Helm 3</option>
                    <option value="install-metrics-server">10 ğŸ“Š CÃ i Ä‘áº·t Metrics Server</option>
                    <option value="install-ingress">11 ğŸŒ CÃ i Ä‘áº·t Nginx Ingress</option>
                    <option value="install-metallb">12 âš–ï¸ CÃ i Ä‘áº·t MetalLB LoadBalancer</option>
                    <option value="setup-storage">13 ğŸ’¾ Thiáº¿t láº­p Storage</option>
                    <option value="prepare-and-join-worker">14 ğŸ”— Chuáº©n bá»‹ & Join Worker (02â†’03â†’04â†’07)</option>
                  </optgroup>
                  <optgroup label="IV. Triá»ƒn khai toÃ n bá»™">
                    <option value="deploy-full-cluster">ğŸš€ Triá»ƒn khai toÃ n bá»™ cluster (0-8, Calico)</option>
                    <option value="deploy-full-cluster-flannel">ğŸš€ Triá»ƒn khai toÃ n bá»™ cluster (0-8, Flannel)</option>
                  </optgroup>
                  <optgroup label="V. Báº£o trÃ¬ & Reset">
                    <option value="reset-cluster">ğŸ§¹ Reset toÃ n bá»™ cluster</option>
                  </optgroup>
                </select>
                <small class="text-muted">Chá»n template Ä‘á»ƒ tá»± Ä‘á»™ng táº¡o ná»™i dung playbook</small>
              </div>
            </div>
            <hr>
            <!-- Content sections -->
            <div id="playbook-content-section">
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label class="form-label">Danh sÃ¡ch playbook</label>
                  <div class="list-group small" id="playbook-list" style="overflow-y: auto;">
                    <div class="list-group-item text-center text-muted">
                      ğŸ“ Äang táº£i...
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-8">
                  <div id="playbook-content-area">
                    <label class="form-label">Ná»™i dung playbook</label>
                    <textarea id="playbook-editor" class="form-control" rows="18"
                      placeholder="---\n- name: Example\n  hosts: all\n  tasks:\n    - debug: msg=\"hello\"\n"></textarea>
                  </div>
                  <!-- Execution status -->
                  <div id="playbook-execution-status" class="d-none"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="d-flex justify-content-between w-100">
              <div>
                <button type="button" class="btn btn-outline-danger d-none" id="delete-playbook-btn">
                  ğŸ—‘ï¸ XÃ³a
                </button>
              </div>
              <div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÄÃ³ng</button>
                <button type="button" class="btn btn-success d-none" id="execute-playbook-btn">
                  â–¶ï¸ Thá»±c thi
                </button>
                <button type="button" class="btn btn-primary" id="save-playbook-btn">
                  ğŸ’¾ LÆ°u
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- End Playbook Manager Modal -->

    <!-- Ansible Installation Modal -->
    <div class="modal fade" id="ansibleInstallModal" tabindex="-1" aria-labelledby="ansibleInstallModalLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="ansibleInstallModalLabel">
              ğŸ“¥ CÃ i Ä‘áº·t Ansible - Real-time Monitoring
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Sudo Password Input Section (Single Master) -->
            <div id="sudo-password-section" class="mb-4">
              <h6 class="mb-3">Nháº­p máº­t kháº©u sudo:</h6>
              <div id="sudo-password-inputs" class="row">
                <!-- Sáº½ Ä‘Æ°á»£c populate báº±ng JavaScript -->
              </div>
              <div class="d-flex justify-content-end mt-3">
                <button type="button" class="btn btn-primary" id="start-ansible-install-btn">
                  â–¶ï¸ Báº¯t Ä‘áº§u cÃ i Ä‘áº·t
                </button>
              </div>
            </div>

            <!-- Real-time Output Section -->
            <div id="ansible-output-section" class="d-none">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">Tiáº¿n trÃ¬nh cÃ i Ä‘áº·t:</h6>
                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-output-btn">
                    ğŸ—‘ï¸ XÃ³a log
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-primary" id="download-log-btn">
                    ğŸ“¥ Táº£i log
                  </button>
                </div>
              </div>

              <!-- Progress Bar -->
              <div class="progress mb-3 h-25">
                <div id="ansible-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                  role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                  <span id="progress-text">Chuáº©n bá»‹...</span>
                </div>
              </div>

              <!-- Server Status (optional, single master) -->
              <div id="server-status-cards" class="row mb-3 d-none">
                <!-- áº¨n máº·c Ä‘á»‹nh vÃ¬ chá»‰ dÃ¹ng 1 MASTER; cÃ³ thá»ƒ hiá»ƒn thá»‹ láº¡i khi cáº§n -->
              </div>

              <!-- Real-time Output Console -->
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h6 class="mb-0">Output Console</h6>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="auto-scroll-switch" checked>
                    <label class="form-check-label" for="auto-scroll-switch">Auto-scroll</label>
                  </div>
                </div>
                <div class="card-body p-0">
                  <div id="ansible-output-console" class="bg-dark text-light p-3" style="height: 400px; overflow: auto; font-family: monospace; font-size: 12px;">
                    <!-- Output sáº½ Ä‘Æ°á»£c hiá»ƒn thá»‹ á»Ÿ Ä‘Ã¢y -->
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÄÃ³ng</button>
            <button type="button" class="btn btn-success d-none" id="ansible-complete-btn">
              âœ… HoÃ n thÃ nh
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- End Ansible Installation Modal -->
  </div>
</div>
<script src="/js/modules/clusterSetup.js"></script>
<script src="/js/modules/ansibleConfig.js"></script>
<script src="/js/modules/ansibleWebSocket.js"></script>
<script src="/js/modules/k8s/playbook-manager.js"></script> 
</body>
</html>

