<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Đăng nhập / Đăng ký</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">

    <script>
        async function login(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;

            try {
                const res = await fetch('/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (!res.ok) {
                    const msg = await res.json().catch(() => ({ message: 'Đăng nhập thất bại' }));
                    setMessage('login-msg', msg.message || 'Đăng nhập thất bại', true);
                    return;
                }

                const out = await res.json().catch(() => ({ redirect: '/home-user' }));
                setMessage('login-msg', 'Đăng nhập thành công, đang chuyển hướng...', false);
                setTimeout(() => window.location.href = out.redirect || '/home-user', 1000);
            } catch (err) {
                setMessage('login-msg', '❌ Lỗi hệ thống: ' + err.message, true);
            }
        }

        async function registerUser(event) {
            event.preventDefault();
            const username = document.getElementById('reg-username').value.trim();
            const password = document.getElementById('reg-password').value;

            const res = await fetch('/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            if (res.ok) {
                setMessage('reg-msg', '🎉 Đăng ký thành công! Vui lòng đăng nhập.', false);
            } else {
                const msg = await res.text();
                setMessage('reg-msg', msg || 'Đăng ký thất bại', true);
            }
        }

        function setMessage(id, text, isError) {
            const el = document.getElementById(id);
            el.innerHTML = `
                <div class="alert ${isError ? 'alert-danger' : 'alert-success'} alert-dismissible fade show p-2 mt-2" role="alert">
                  ${text}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Đóng"></button>
                </div>`;
        }

        // Loading UI helpers
        function showLoading(msg) {
            let div = document.createElement('div');
            div.id = 'loading-indicator';
            div.style = `
                position:fixed;top:0;left:0;width:100vw;height:100vh;
                display:flex;align-items:center;justify-content:center;
                background:rgba(255,255,255,0.75);z-index:9999;`;
            div.innerHTML = `
                <div style='text-align:center'>
                  <div class="spinner-border text-primary mb-3" role="status"></div>
                  <br><span>${msg}</span>
                </div>`;
            document.body.appendChild(div);
        }
        function hideLoading() {
            const d = document.getElementById('loading-indicator');
            if (d) d.remove();
        }
    </script>
</head>

<body class="bg-light">
    <div class="container py-5">
        <div class="row g-4">

            <!-- Đăng nhập -->
            <div class="col-12 col-lg-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h2 class="h5 mb-1">Đăng nhập</h2>
                        <p class="text-muted mb-3">Nhập tên đăng nhập và mật khẩu để tiếp tục</p>
                        <form onsubmit="login(event)">
                            <div class="mb-3">
                                <label for="login-username" class="form-label">Tên đăng nhập</label>
                                <input id="login-username" class="form-control" autocomplete="username" required>
                            </div>
                            <div class="mb-3">
                                <label for="login-password" class="form-label">Mật khẩu</label>
                                <input id="login-password" type="password" class="form-control"
                                    autocomplete="current-password" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Đăng nhập</button>
                        </form>
                        <div id="login-msg"></div>
                    </div>
                </div>
            </div>

            <!-- Đăng ký -->
            <div class="col-12 col-lg-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h2 class="h5 mb-1">Đăng ký</h2>
                        <p class="text-muted mb-3">Tạo tài khoản mới</p>
                        <form onsubmit="registerUser(event)">
                            <div class="mb-3">
                                <label for="reg-username" class="form-label">Tên đăng nhập</label>
                                <input id="reg-username" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="reg-password" class="form-label">Mật khẩu</label>
                                <input id="reg-password" type="password" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-success w-100">Đăng ký</button>
                        </form>
                        <div id="reg-msg"></div>
                    </div>
                </div>
            </div>

        </div>

    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
</body>

</html>