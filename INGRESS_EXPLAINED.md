# ğŸŒ INGRESS TRONG KUBERNETES - GIáº¢I THÃCH CHI TIáº¾T

## ğŸ¯ Táº I SAO Cáº¦N INGRESS?

### **Váº¥n Ä‘á» vá»›i SSH Deployment (Hiá»‡n táº¡i):**

Khi deploy app qua SSH, báº¡n pháº£i:
1. âœ… Cháº¡y app trÃªn má»™t port cá»¥ thá»ƒ (vd: 3000, 8080, 8000...)
2. âŒ Pháº£i quáº£n lÃ½ ports thá»§ cÃ´ng (allocate, track conflicts)
3. âŒ Pháº£i cáº¥u hÃ¬nh DNS thá»§ cÃ´ng cho má»—i app
4. âŒ Pháº£i setup reverse proxy (Nginx) thá»§ cÃ´ng
5. âŒ URL cÃ³ port: `http://myapp.example.com:3000`
6. âŒ Pháº£i cáº¥u hÃ¬nh SSL/TLS thá»§ cÃ´ng cho má»—i app
7. âŒ KhÃ³ scale (pháº£i setup load balancer thá»§ cÃ´ng)

**VÃ­ dá»¥ hiá»‡n táº¡i:**
```
App 1: myapp1.example.com:3000
App 2: myapp2.example.com:3001
App 3: myapp3.example.com:3002
...
â†’ Pháº£i quáº£n lÃ½ tá»«ng port vÃ  DNS entry!
```

---

### **Giáº£i phÃ¡p vá»›i K8s Ingress:**

**Ingress** lÃ  má»™t Kubernetes resource cho phÃ©p:
- âœ… **Tá»± Ä‘á»™ng route traffic** dá»±a trÃªn domain name
- âœ… **KhÃ´ng cáº§n quáº£n lÃ½ ports** (dÃ¹ng standard ports 80/443)
- âœ… **Wildcard DNS**: Má»™t DNS entry cho táº¥t cáº£ apps
- âœ… **Auto SSL/TLS**: cert-manager tá»± Ä‘á»™ng issue certificates
- âœ… **Load balancing tá»± Ä‘á»™ng**: K8s Service handle
- âœ… **URL sáº¡ch**: `https://myapp.apps.example.com` (khÃ´ng cáº§n port)

**VÃ­ dá»¥ vá»›i Ingress:**
```
App 1: https://myapp1.apps.example.com
App 2: https://myapp2.apps.example.com
App 3: https://myapp3.apps.example.com
...
â†’ Táº¥t cáº£ dÃ¹ng port 443, tá»± Ä‘á»™ng route!
```

---

## ğŸ—ï¸ KIáº¾N TRÃšC INGRESS

```
Internet
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DNS: *.apps.example.com                 â”‚
â”‚       â†’ Ingress Controller IP (Load Balancer) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ingress Controller (Nginx/Traefik)     â”‚
â”‚  - Äá»c Ingress rules                    â”‚
â”‚  - Route theo host/path                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Kubernetes Cluster                     â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Ingress Resource                 â”‚  â”‚
â”‚  â”‚ - Host: myapp1.apps.example.com  â”‚  â”‚
â”‚  â”‚ - Path: /                        â”‚  â”‚
â”‚  â”‚ - Backend: myapp1-service:80    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                      â”‚
â”‚                 â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Service: myapp1-service         â”‚  â”‚
â”‚  â”‚ - Type: ClusterIP                â”‚  â”‚
â”‚  â”‚ - Port: 80                       â”‚  â”‚
â”‚  â”‚ - Selector: app=myapp1           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                      â”‚
â”‚                 â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Pod: myapp1-pod                  â”‚  â”‚
â”‚  â”‚ - Container: myapp1-container    â”‚  â”‚
â”‚  â”‚ - Port: 3000                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ INGRESS RESOURCE EXAMPLE

### **Ingress Manifest:**

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: myapp-ingress
  namespace: user-123  # Namespace cá»§a user
  annotations:
    # Ingress Controller (Nginx)
    kubernetes.io/ingress.class: nginx
    
    # SSL/TLS tá»± Ä‘á»™ng (cert-manager)
    cert-manager.io/cluster-issuer: letsencrypt-prod
    
    # Rewrite rules (optional)
    nginx.ingress.kubernetes.io/rewrite-target: /
    
    # CORS (optional)
    nginx.ingress.kubernetes.io/enable-cors: "true"
spec:
  # SSL/TLS Configuration
  tls:
  - hosts:
    - myapp.apps.example.com
    secretName: myapp-tls  # Auto-generated by cert-manager
  
  # Routing Rules
  rules:
  - host: myapp.apps.example.com  # Subdomain tá»± Ä‘á»™ng
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: myapp-service  # Service name
            port:
              number: 80
```

### **Service Manifest (required):**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: myapp-service
  namespace: user-123
spec:
  type: ClusterIP  # Internal service
  ports:
  - port: 80
    targetPort: 3000  # Port cá»§a container
    protocol: TCP
  selector:
    app: myapp  # Match vá»›i Pod labels
```

### **Deployment Manifest:**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-deployment
  namespace: user-123
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp-container
        image: registry.example.com/user123/myapp:v1.0.0
        ports:
        - containerPort: 3000
```

---

## ğŸ”„ FLOW DEPLOYMENT Vá»šI INGRESS

### **Step-by-step:**

1. **User upload app** â†’ Build Docker image â†’ Push to registry
2. **Deploy Pod**: Táº¡o Deployment vá»›i image tá»« registry
3. **Create Service**: Expose Pod qua ClusterIP Service (port 80)
4. **Create Ingress**: Táº¡o Ingress rule vá»›i subdomain `{app-name}.apps.example.com`
5. **Auto DNS**: Wildcard DNS `*.apps.example.com` Ä‘Ã£ trá» Ä‘áº¿n Ingress Controller
6. **Auto SSL**: cert-manager tá»± Ä‘á»™ng issue Let's Encrypt certificate
7. **Ready!**: App accessible táº¡i `https://{app-name}.apps.example.com`

---

## ğŸ”§ SETUP INGRESS CONTROLLER

### **1. Install Nginx Ingress Controller:**

```bash
# Sá»­ dá»¥ng Helm (recommended)
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update
helm install ingress-nginx ingress-nginx/ingress-nginx \
  --namespace ingress-nginx \
  --create-namespace

# Hoáº·c dÃ¹ng kubectl apply
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.2/deploy/static/provider/cloud/deploy.yaml
```

### **2. Get Ingress Controller IP:**

```bash
kubectl get svc -n ingress-nginx ingress-nginx-controller

# Output:
# NAME                       TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)
# ingress-nginx-controller   LoadBalancer   10.96.0.1       203.0.113.1      80:30080/TCP,443:30443/TCP
```

### **3. Configure DNS:**

**Wildcard DNS Entry:**
```
*.apps.example.com  A  203.0.113.1
```

â†’ Táº¥t cáº£ subdomains sáº½ tá»± Ä‘á»™ng trá» Ä‘áº¿n Ingress Controller!

---

## ğŸ”’ SSL/TLS Tá»° Äá»˜NG Vá»šI CERT-MANAGER

### **1. Install cert-manager:**

```bash
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
```

### **2. Create ClusterIssuer (Let's Encrypt):**

```yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@example.com
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: nginx
```

### **3. Ingress sáº½ tá»± Ä‘á»™ng:**

Khi báº¡n táº¡o Ingress vá»›i annotation:
```yaml
cert-manager.io/cluster-issuer: letsencrypt-prod
```

â†’ cert-manager tá»± Ä‘á»™ng:
- âœ… Issue certificate tá»« Let's Encrypt
- âœ… Táº¡o Secret chá»©a certificate
- âœ… Auto-renew trÆ°á»›c khi expire

---

## ğŸ’¡ Lá»¢I ÃCH KHI DEPLOY Báº°NG K8S + INGRESS

### **So sÃ¡nh trá»±c tiáº¿p:**

| TÃ­nh nÄƒng | SSH Deployment | K8s + Ingress |
|-----------|---------------|--------------|
| **URL** | `http://myapp.example.com:3000` | `https://myapp.apps.example.com` âœ… |
| **Port Management** | Manual (track tá»«ng port) | Auto (standard 80/443) âœ… |
| **DNS Setup** | Manual per app | Wildcard (1 láº§n) âœ… |
| **SSL/TLS** | Manual per app | Auto (cert-manager) âœ… |
| **Load Balancing** | Manual (Nginx/HAProxy) | Auto (K8s Service) âœ… |
| **Scaling** | Manual | Auto (HPA) âœ… |
| **Multi-path** | Complex | Simple (Ingress rules) âœ… |

### **VÃ­ dá»¥ thá»±c táº¿:**

**SSH Deployment:**
```
App: myecommerce
â†’ Port: 3000
â†’ DNS: myecommerce.example.com â†’ server-ip:3000
â†’ Nginx config: 
   server {
     listen 80;
     server_name myecommerce.example.com;
     location / {
       proxy_pass http://localhost:3000;
     }
   }
â†’ SSL: Manual certbot setup
â†’ URL: https://myecommerce.example.com (pháº£i setup SSL thá»§ cÃ´ng)
```

**K8s + Ingress:**
```yaml
# Chá»‰ cáº§n táº¡o Ingress resource:
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: myecommerce-ingress
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - myecommerce.apps.example.com
    secretName: myecommerce-tls
  rules:
  - host: myecommerce.apps.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: myecommerce-service
            port:
              number: 80
```

â†’ **Tá»± Ä‘á»™ng:**
- âœ… DNS: Wildcard `*.apps.example.com` Ä‘Ã£ cÃ³
- âœ… SSL: cert-manager tá»± Ä‘á»™ng issue
- âœ… URL: `https://myecommerce.apps.example.com`
- âœ… Load balancing: Auto
- âœ… Scaling: CÃ³ thá»ƒ scale Pods, Service tá»± Ä‘á»™ng load balance

---

## ğŸš€ CODE IMPLEMENTATION (Phase 2-3)

### **KubernetesService.java (Phase 2):**

```java
@Service
public class KubernetesService {
    
    /**
     * Deploy app to K8s vá»›i Ingress tá»± Ä‘á»™ng
     */
    public void deployToKubernetes(Application app, String imageTag) {
        // 1. Create Namespace (náº¿u chÆ°a cÃ³)
        createNamespaceIfNotExists(app.getUser().getId());
        
        // 2. Deploy Pod (via Deployment)
        createDeployment(app, imageTag);
        
        // 3. Create Service
        createService(app);
        
        // 4. Create Ingress (Phase 3) - Tá»° Äá»˜NG Cáº¤P Äá»ŠA CHá»ˆ
        createIngress(app);
    }
    
    /**
     * Táº¡o Ingress tá»± Ä‘á»™ng vá»›i subdomain
     */
    private void createIngress(Application app) {
        String subdomain = app.getSubdomain();  // myapp
        String host = subdomain + ".apps.example.com";  // myapp.apps.example.com
        
        Ingress ingress = new IngressBuilder()
            .withNewMetadata()
                .withName(app.getSubdomain() + "-ingress")
                .withNamespace("user-" + app.getUser().getId())
                .addToAnnotations("kubernetes.io/ingress.class", "nginx")
                .addToAnnotations("cert-manager.io/cluster-issuer", "letsencrypt-prod")
            .endMetadata()
            .withNewSpec()
                .addNewTl()
                    .addToHosts(host)
                    .withSecretName(app.getSubdomain() + "-tls")
                .endTl()
                .addNewRule()
                    .withHost(host)
                    .withNewHttp()
                        .addNewPath()
                            .withPath("/")
                            .withPathType("Prefix")
                            .withNewBackend()
                                .withNewService()
                                    .withName(app.getSubdomain() + "-service")
                                    .withNewPort()
                                        .withNumber(80)
                                    .endPort()
                                .endService()
                            .endBackend()
                        .endPath()
                    .endHttp()
                .endRule()
            .endSpec()
            .build();
        
        kubernetesClient.network().ingresses()
            .inNamespace("user-" + app.getUser().getId())
            .create(ingress);
        
        // Update accessUrl: https://myapp.apps.example.com
        app.setAccessUrl("https://" + host);
    }
}
```

---

## ğŸ“‹ CHECKLIST DEPLOYMENT Vá»šI INGRESS

### **Setup (1 láº§n):**
- [ ] Install Ingress Controller (Nginx)
- [ ] Get Ingress Controller External IP
- [ ] Configure Wildcard DNS: `*.apps.example.com` â†’ Ingress IP
- [ ] Install cert-manager (optional, cho SSL auto)
- [ ] Create ClusterIssuer (Let's Encrypt)

### **Per Application (Tá»± Ä‘á»™ng):**
- [ ] Deploy Pod (via Deployment)
- [ ] Create Service (ClusterIP)
- [ ] Create Ingress vá»›i subdomain
- [ ] Auto SSL certificate (náº¿u cÃ³ cert-manager)
- [ ] Update accessUrl trong DB: `https://{subdomain}.apps.example.com`

---

## ğŸ¯ Káº¾T LUáº¬N

**Ingress trong K8s lÃ  giáº£i phÃ¡p hoÃ n háº£o Ä‘á»ƒ:**
- âœ… **Tá»± Ä‘á»™ng cáº¥p Ä‘á»‹a chá»‰** cho má»—i application
- âœ… **URL sáº¡ch** khÃ´ng cáº§n port numbers
- âœ… **SSL/TLS tá»± Ä‘á»™ng** vá»›i cert-manager
- âœ… **Load balancing tá»± Ä‘á»™ng**
- âœ… **Centralized management**

**ÄÃ³ lÃ  lÃ½ do táº¡i sao cáº§n chuyá»ƒn tá»« SSH deployment sang K8s deployment!**

